---
- name: Fedora machine setup
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  tasks:
    - name: Install the RPM Fusion and Fonts repo packages
      ansible.builtin.dnf:
        state: present
        disable_gpg_check: yes
        name:
          - https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-{{ ansible_facts.distribution_version }}.noarch.rpm
          - https://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-{{ ansible_facts.distribution_version }}.noarch.rpm

    - name: Install packages
      ansible.builtin.dnf:
        state: present
        name:
          - autoconf
          - bat
          - blender
          - bzip2
          - bzip2-devel
          - "@C Development Tools and Libraries"
          - croc
          - "@Development Tools"
          - dotnet-sdk-9.0
          - fastfetch
          - fd-find
          - ffmpeg-free
          - firefox
          - fzf
          - git
          - gnome-tweaks
          - go
          - go-task
          - gparted
          - "@Haskell"
          - helix
          - htop
          - ImageMagick
          - java-latest-openjdk-devel
          - kitty
          - "@multimedia"
          - nasm
          - ncurses-devel
          - neovim
          - opam
          - openssl-devel
          - patch
          - podman-compose
          - poetry
          - readline-devel
          - remove-retired-packages
          - ripgrep
          - ruby
          - ruby-devel
          - sqlite
          - sqlite-devel
          - syncthing
          - tig
          - tk-devel
          - tmux
          - toilet
          - unar
          - vim
          - "@virtualization"
          - wl-clipboard
          - xxd
          - xz-devel
          - yarnpkg
          - zig
          - zlib
          - zlib-devel
          - zsh

    - name: Change shell to zsh
      ansible.builtin.user:
        name: "{{ username }}"
        shell: /usr/bin/zsh

    - name: Ensuring Oh My Zsh is installed
      ansible.builtin.stat:
        path: "~{{ username }}/.oh-my-zsh"
      register: oh_my_zsh_check

    - name: Install Oh My Zsh
      ansible.builtin.git:
        repo: https://github.com/ohmyzsh/ohmyzsh.git
        dest: "~{{ username }}/.oh-my-zsh"
        depth: 1
      when: not oh_my_zsh_check.stat.exists

    - name: Ensuring Oh My Zsh zsh-autosuggestions installed
      ansible.builtin.stat:
        path: "~{{ username }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
      register: zsh_autosuggestions_check

    - name: Install Oh My Zsh zsh-autosuggestions
      ansible.builtin.git:
        repo: https://github.com/zsh-users/zsh-autosuggestions.git
        dest: "~{{ username }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
        depth: 1
      when: not zsh_autosuggestions_check.stat.exists

    - name: Ensuring Oh My Zsh zsh-syntax-highlighting installed
      ansible.builtin.stat:
        path: "~{{ username }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
      register: zsh_syntax_highlighting_check

    - name: Install Oh My Zsh zsh-syntax-highlighting
      ansible.builtin.git:
        repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
        dest: "~{{ username }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
        depth: 1
      when: not zsh_syntax_highlighting_check.stat.exists

    - name: Install DNF plugins core
      ansible.builtin.dnf:
        name: dnf-plugins-core
        state: present

    - name: Add Google GPG key
      ansible.builtin.rpm_key:
        key: https://dl.google.com/linux/linux_signing_key.pub
        state: present

    - name: Add Google Chrome repo
      ansible.builtin.yum_repository:
        name: google-chrome
        description: google-chrome repository
        baseurl: http://dl.google.com/linux/chrome/rpm/stable/x86_64
        enabled: true
        gpgcheck: true
        gpgkey: https://dl.google.com/linux/linux_signing_key.pub

    - name: Install Google Chrome stable
      ansible.builtin.yum:
        name: "google-chrome-stable"
        state: latest 
        update_cache: true

    - name: Import Microsoft GPG key
      ansible.builtin.rpm_key:
        key: https://packages.microsoft.com/keys/microsoft.asc
        state: present

    - name: Add Visual Studio Code repo
      ansible.builtin.yum_repository:
        name: vscode
        description: Visual Studio Code
        baseurl: https://packages.microsoft.com/yumrepos/vscode
        gpgkey: https://packages.microsoft.com/keys/microsoft.asc
        gpgcheck: true
        enabled: true

    - name: Install Visual Studio Code
      ansible.builtin.dnf:
        state: present
        name: code

    - name: Add Docker repo
      ansible.builtin.yum_repository:
        name: docker
        description: Docker repo
        baseurl: "https://download.docker.com/linux/fedora/{{ ansible_distribution_major_version }}/{{ ansible_architecture }}/stable"
        gpgkey: "https://download.docker.com/linux/fedora/gpg"
        gpgcheck: true
        enabled: true

    - name: Install Docker
      ansible.builtin.dnf:
        state: present
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin

    - name: Add Docker group
      ansible.builtin.group:
        state: present
        name: docker

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ username }}"
        groups: docker
        append: true

    - name: Ensuring ASDF is installed
      ansible.builtin.stat:
        path: "~{{ username }}/.asdf"
      register: asdf_check

    - name: Install ASDF
      ansible.builtin.git:
        repo: https://github.com/asdf-vm/asdf.git
        dest: "~{{ username }}/.asdf"
        depth: 1
      when: not asdf_check.stat.exists

    - name: Enable Fedora Copr for Lua Language Server
      command: dnf copr enable -y yorickpeterse/lua-language-server

    - name: Install Lua Language Server
      ansible.builtin.dnf:
        name: lua-language-server
        state: present

    - name: Enable Fedora Copr for Ghostty
      command: dnf copr enable -y pgdev/ghostty

    - name: Install Ghostty
      ansible.builtin.dnf:
        name: ghostty
        state: present

    - name: Enable Fedora Copr for Tmuxinator
      command: dnf copr enable -y fcsm/tmuxinator

    - name: Install Tmuxinator
      ansible.builtin.dnf:
        name: tmuxinator
        state: present

    - name: Enable Fedora Copr for Iosevka
      command: dnf copr enable -y peterwu/iosevka

    - name: Install Iosevka
      ansible.builtin.dnf:
        name: iosevka-fonts
        state: present

    - name: Install Flatpak packages
      community.general.flatpak:
        state: present
        name:
          - com.bitwarden.desktop
          - com.calibre_ebook.calibre
          - com.dropbox.Client
          - com.getpostman.Postman
          - com.google.AndroidStudio
          - com.jetbrains.DataGrip
          - com.jetbrains.IntelliJ-IDEA-Community
          - com.obsproject.Studio
          - com.spotify.Client
          - com.valvesoftware.Steam
          - edu.mit.Scratch
          - fr.handbrake.ghb
          - io.dbeaver.DBeaverCommunity
          - io.github.Figma_Linux.figma_linux
          - md.obsidian.Obsidian
          - org.audacityteam.Audacity
          - org.gimp.GIMP
          - org.sqlitebrowser.sqlitebrowser
          - org.standardnotes.standardnotes
          - org.telegram.desktop
          - org.videolan.VLC
          - org.wireshark.Wireshark
          - rest.insomnia.Insomnia
          - us.zoom.Zoom

    - name: Ensuring nerd-fonts is installed
      ansible.builtin.stat:
        path: "~{{ username }}/.nerd-fonts"
      register: nerd_fonts_check

    - name: Install nerd-fonts
      ansible.builtin.git:
        repo: https://github.com/ryanoasis/nerd-fonts.git
        dest: "~{{ username }}/.nerd-fonts"
        depth: 1
      when: not nerd_fonts_check.stat.exists

    - name: "Running tasks as {{ username }}"
      become: true
      become_user: "{{ username }}"
      block:
        - name: Ensuring rustup is installed
          ansible.builtin.stat:
            path: "~{{ username }}/.rustup"
          register: rustup_check

        - name: Install rustup
          ansible.builtin.shell: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          when: not rustup_check.stat.exists

        - name: Enable syncthing service
          ansible.builtin.shell: "systemctl enable syncthing@{{ username }}.service"
